---
title: "Branch-Level Regressions: ZIP Competitor Dynamics"
author: "Generated Output"
format:
  html:
    self-contained: true
    code-overflow: scroll
    toc: true
execute:
  warning: false
  echo: true
---

Minimal version of `results_competitor_close_open_v4.0.qmd` that analyzes branch-level
deposit growth as a function of competitor closures/openings at the ZIP level.

# Setup

```{r}
#| warning: false
#| messages: false

rm(list=ls())
library(data.table)
library(fixest)
library(DescTools)
library(dplyr)

# Load summary stats function
source('https://raw.githubusercontent.com/dratnadiwakara/r-utilities/refs/heads/main/summary_stat_tables.R')

# Load branch ZIP panel
panel_path <- "C:/OneDrive/data/branch_zip_panel.rds"
dt <- readRDS(panel_path)
setDT(dt)

# Sample restrictions: branches with no own closures/openings
dt_3yr <- dt[own_closures_zip == 0 & 
             own_openings_zip == 0 & 
             !is.na(dep_gr_3yr) &
             dep_gr_3yr < 1]


# Winsorize for 3-year sample
dt_3yr[, dep_gr_3yr := Winsorize(dep_gr_3yr, 
                                                val = quantile(dep_gr_3yr, 
                                                               probs = c(0.01, 0.99), na.rm = TRUE))]



```

# Summary Statistics

## Sample Overview

```{r}
#| warning: false
#| messages: false

cat("3-Year Growth Sample:\n")
cat("  Observations:", nrow(dt_3yr), "\n")
cat("  Unique branches:", uniqueN(dt_3yr$UNINUMBR), "\n")
cat("  Unique ZIPs:", uniqueN(dt_3yr$zip), "\n")
cat("  Years:", min(dt_3yr$YEAR), "to", max(dt_3yr$YEAR), "\n\n")
cat("  Mean dep_gr_3yr:", round(mean(dt_3yr$dep_gr_3yr, na.rm = TRUE), 4), "\n")
cat("  Mean competitor_close_dep_share_prev:", 
    round(mean(dt_3yr$competitor_close_dep_share_prev, na.rm = TRUE), 4), "\n")
```

## Summary Stats for 2019 (Full Sample)

```{r}
#| warning: false
#| messages: false

# -----------------------------------------------------------------------------
# SUMMARY STATISTICS
# -----------------------------------------------------------------------------
# Purpose: Generate summary stats for all variables used in the regression analysis.
# -----------------------------------------------------------------------------

vars <- c(
  # --- Dependent Variable ---
  "dep_gr_3yr",                       # 3-year branch deposit growth
  
  # --- Shock Variables (Grouped by App Quality) ---
  "competitor_close_dep_share_prev",  # Total competitor closure share
  "competitor_close_share_no_app",    # No app closures (bin 0)
  "competitor_close_share_low_app",   # Low app closures (bins 1-2)
  "competitor_close_share_high_app",  # High app closures (bins 3-4)
  
  # --- Branch Control ---
  "DEPSUMBR",                         # Branch deposits
  
  # --- Demographics ---
  "sophisticated",                    # Binary: sophisticated ZIP
  "above_median_age",                 # Binary: above median age
  "above_median_income"               # Binary: above median income
)

# Table 1: Summary Stats for 2019 (Full Sample)
temp <- summary_stats_function(dt_3yr[YEAR == 2019], vars)
md_table(temp)

```

## Summary Stats for 2019 (Conditioned on Non-Zero Competitor Closure)

```{r}
#| warning: false
#| messages: false

# Table 2: Summary Stats for 2019 (Conditioned on Non-Zero Competitor Closure)
# Shows stats specifically for branches affected by competitor closures
temp <- summary_stats_function(dt_3yr[YEAR == 2019 & competitor_close_dep_share_prev > 0], vars)
md_table(temp)

```

# Analysis

## Define Fixed Effects and Formulas

```{r}
#| warning: false
#| messages: false

setFixest_fml(
  ..fixef_br_ctyyr = ~ UNINUMBR + county_yr,
  ..fixef_ctyyr_bnkyr = ~ county_yr + bank_yr,
  ..fixef_br_ctyyr_bnkyr = ~ UNINUMBR + county_yr + bank_yr,
  ..fml_baseline_amt = ~ competitor_close_dep_share_prev + log1p(DEPSUMBR),
  ..fml_interact = ~ competitor_close_dep_share_prev*sophisticated + competitor_close_dep_share_prev*above_median_age + competitor_close_dep_share_prev*above_median_income + log1p(DEPSUMBR)
)

# Variable labels
dict <- c(
  dep_gr_3yr = "Dep growth (t to t+3)",
  dep_gr_1yr = "Dep growth (t to t+1)",
  competitor_closures_rate = "Competitor closure rate (ZIP)",
  competitor_close_dep_share_prev = "Competitor closure dep share (t-1)",
  "log1p(DEPSUMBR)" = "log(Deposits)"
)

setFixest_etable(
  dict = dict,
  se.below = TRUE
)

```

## Baseline Regressions

Test whether competitor closures lead to deposit inflows at surviving branches.

```{r}
#| warning: false
#| messages: false

r <- list()

# Model 1: Branch FE + County-Year FE (deposit share measure)
r[[1]] <- feols(dep_gr_3yr ~ ..fml_baseline_amt | ..fixef_br_ctyyr, 
                data = dt_3yr)

# Model 2: County-Year FE + Bank-Year FE (deposit share)
r[[2]] <- feols(dep_gr_3yr ~ ..fml_baseline_amt | ..fixef_ctyyr_bnkyr, 
                data = dt_3yr, 
                vcov = ~ UNINUMBR)

# Model 3: All three FE (deposit share)
r[[3]] <- feols(dep_gr_3yr ~ ..fml_baseline_amt | ..fixef_br_ctyyr_bnkyr, 
                data = dt_3yr)


etable(r, 
       signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
       headers = c("Br+Cty-Yr", "Cty-Yr+Bnk-Yr", "All FE"))

```

## Time Heterogeneity

Split by time periods to test if effects vary across crisis/recovery/modern eras.

```{r}
#| warning: false
#| messages: false

r <- list()

r[[1]] <-  feols(dep_gr_3yr ~ ..fml_baseline_amt | ..fixef_ctyyr_bnkyr, 
                data = dt_3yr[YEAR %in% 2001:2011])

r[[2]] <- feols(dep_gr_3yr ~ ..fml_baseline_amt | ..fixef_ctyyr_bnkyr, 
                data = dt_3yr[YEAR %in% 2012:2021])

etable(r, 
       signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
       headers = c("2001-2011", "2012-2021"))

```
## Time Heterogeneity-Interaction


```{r}
#| warning: false
#| messages: false

r <- list()

r[[1]] <-  feols(dep_gr_3yr ~ ..fml_interact  | ..fixef_ctyyr_bnkyr, 
                data = dt_3yr[YEAR %in% 2001:2011], 
                vcov = ~ UNINUMBR)

r[[2]] <- feols(dep_gr_3yr ~ ..fml_interact  | ..fixef_ctyyr_bnkyr, 
                data = dt_3yr[YEAR %in% 2012:2021], 
                vcov = ~ UNINUMBR)

etable(r, 
       signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
       headers = c("2001-2011", "2012-2021"))

```

## App Quality of Competitor Closers

Test whether closures by high-app vs low-app competitors have different effects.
The three app quality groups have comparable scales for easier interpretation.

```{r}
#| warning: false
#| messages: false

r <- list()

# Model 1: Baseline with total closure share
r[[1]] <- feols(dep_gr_3yr ~ competitor_close_dep_share_prev + log1p(DEPSUMBR) | UNINUMBR + county_yr + bank_yr, 
                data = dt_3yr)

# Model 2: Grouped - high app (bins 3-4) vs low app (bins 1-2) vs no app (bin 0)
r[[2]] <- feols(dep_gr_3yr ~ competitor_close_share_high_app + 
                            competitor_close_share_low_app + 
                            competitor_close_share_no_app +
                            log1p(DEPSUMBR) | UNINUMBR + county_yr + bank_yr, 
                data = dt_3yr)

etable(r, 
       signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
       headers = c("Total", "By App Group"))

```

## App Quality: Time Heterogeneity

Test whether app quality effects differ across time periods.

```{r}
#| warning: false
#| messages: false

r <- list()

# Pre-2012: Split by app quality
r[[1]] <- feols(dep_gr_3yr ~ competitor_close_share_high_app + 
                            competitor_close_share_low_app + 
                            competitor_close_share_no_app +
                            log1p(DEPSUMBR) | UNINUMBR + county_yr + bank_yr, 
                data = dt_3yr[YEAR %in% 2001:2011])

# Post-2012: Split by app quality
r[[2]] <- feols(dep_gr_3yr ~ competitor_close_share_high_app + 
                            competitor_close_share_low_app + 
                            competitor_close_share_no_app +
                            log1p(DEPSUMBR) | UNINUMBR + county_yr + bank_yr, 
                data = dt_3yr[YEAR %in% 2012:2021])

etable(r, 
       signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
       headers = c("Pre-2012", "Post-2012"))

```

## App Quality: Demographic Interactions

Test whether effects vary by ZIP demographics (sophistication, age, income).

```{r}
#| warning: false
#| messages: false

r <- list()

# Model 1: Interaction with sophisticated ZIP
r[[1]] <- feols(dep_gr_3yr ~ (competitor_close_share_high_app + 
                              competitor_close_share_low_app + 
                              competitor_close_share_no_app) * sophisticated +
                            log1p(DEPSUMBR) | UNINUMBR + county_yr + bank_yr, 
                data = dt_3yr,
                vcov = ~ UNINUMBR)

# Model 2: Interaction with above median age
r[[2]] <- feols(dep_gr_3yr ~ (competitor_close_share_high_app + 
                              competitor_close_share_low_app + 
                              competitor_close_share_no_app) * above_median_age +
                            log1p(DEPSUMBR) | UNINUMBR + county_yr + bank_yr, 
                data = dt_3yr,
                vcov = ~ UNINUMBR)

# Model 3: Interaction with above median income
r[[3]] <- feols(dep_gr_3yr ~ (competitor_close_share_high_app + 
                              competitor_close_share_low_app + 
                              competitor_close_share_no_app) * above_median_income +
                            log1p(DEPSUMBR) | UNINUMBR + county_yr + bank_yr, 
                data = dt_3yr,
                vcov = ~ UNINUMBR)

etable(r, 
       signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.10),
       headers = c("Sophisticated", "Above Med Age", "Above Med Income"))

```

