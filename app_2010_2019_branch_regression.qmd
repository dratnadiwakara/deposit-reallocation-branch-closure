---
title: "Branch Panel (2010-2019): App Data Build + Regression"
author: "Generated Output"
format:
  html:
    self-contained: true
    code-overflow: scroll
    toc: true
execute:
  warning: false
  echo: true
---



```{r}
rm(list=ls())
library(data.table)
library(stringr)
library(fixest)
library(DescTools)
library(ggplot2)
library(dplyr)

# Load summary stats function
source('https://raw.githubusercontent.com/dratnadiwakara/r-utilities/refs/heads/main/summary_stat_tables.R')

# Inputs (adjust paths)
closure_path   <- "C:/OneDrive/data/closure_opening_data_simple.rds"
app_panel_path <- "C:/OneDrive/data/CH_full_app_reviews_panel.csv"
fdic_path      <- "C:/OneDrive/data/fdic_sod_2000_2025_simple.rds"

start_year <- 2012
end_year   <- 2025
```


```{r}
#-----------------------------
# 0) Load data
#-----------------------------
closure_raw <- readRDS(closure_path); setDT(closure_raw)
closure_raw[, county := str_pad(STCNTYBR, 5, "left", "0")]
closure_raw[, YEAR := as.integer(YEAR)]

app_panel <- fread(app_panel_path); setDT(app_panel)
app_panel <- app_panel[, .(
  CERT = FDIC_certificate_id,
  YEAR = as.integer(year),
  first_app_available,    
  reviews_available,
  yearly_rating,
  tot_assets
)]

app_panel[, has_app := fifelse(first_app_available == 1, 1L, 0L)]

# Extend panel: app_panel stops at 2021; carry forward 2021 values to 2022-2025
app_2021 <- app_panel[YEAR == 2021]
if (nrow(app_2021) > 0) {
  app_extended <- rbindlist(lapply(2022:2025, function(y) {
    out <- copy(app_2021)
    out[, YEAR := y]
    out
  }))
  app_panel <- rbind(app_panel, app_extended)
}
```


```{r}
#-----------------------------
# 1) Branch-level lags/leads for growth
#-----------------------------
setorder(closure_raw, UNINUMBR, YEAR)

closure_raw[, `:=`(
  dep_lag1   = shift(DEPSUMBR, 1L, type = "lag"),
  year_lag1  = shift(YEAR,    1L, type = "lag"),
  dep_lead1  = shift(DEPSUMBR, 1L, type = "lead"),
  year_lead1 = shift(YEAR,    1L, type = "lead")
), by = UNINUMBR]

closure_raw[, dep_lag1_aligned  := fifelse(year_lag1  == YEAR - 1L, dep_lag1,  NA_real_)]
closure_raw[, dep_lead1_aligned := fifelse(year_lead1 == YEAR + 1L, dep_lead1, NA_real_)]

closure_raw[, gr_branch := fifelse(!is.na(dep_lag1_aligned) & dep_lag1_aligned > 0,
                                   (dep_lead1_aligned - dep_lag1_aligned) / dep_lag1_aligned,
                                   NA_real_)]

#-----------------------------
# 2) Merge bank-year app indicator onto branch-year
#-----------------------------
closure_app <- merge(
  closure_raw,
  app_panel[, .(CERT, YEAR, has_app, yearly_rating, tot_assets)],
  by = c("CERT", "YEAR"),
  all.x = TRUE
)
closure_app[is.na(has_app), has_app := 0L]
closure_app[, own_bank_has_app := has_app]
closure_app[, own_bank_app_rating := fifelse(!is.na(yearly_rating) & is.finite(yearly_rating), yearly_rating, 0)]
```


```{r}
#-----------------------------
# 3) County-year closure shares and ABSOLUTE AMOUNTS
#-----------------------------
sum_na_safe <- function(x) if (all(is.na(x))) NA_real_ else as.numeric(sum(x, na.rm = TRUE))

top4_cert <- c(628L, 3510L, 3511L, 7213L)

county_totals <- closure_app[, .(
  total_deps_county_lag1 = sum_na_safe(dep_lag1_aligned)
), by = .(county, YEAR)]

# Large bank: >$100B assets (tot_assets in thousands, same as bank_county_year_regression)
large_cert <- unique(closure_app[!is.na(tot_assets) & tot_assets > 100000000, CERT])

# Four mutually exclusive categories: top4, large_but_not_top4, small, (app/noapp kept for compatibility)
closed_by_app <- closure_app[closed == 1L, .(
  cl_closed_top4  = sum_na_safe(fifelse(CERT %in% top4_cert, dep_lag1_aligned, NA_real_)),
  cl_closed_large_but_not_top4 = sum_na_safe(fifelse(!(CERT %in% top4_cert) & CERT %in% large_cert, dep_lag1_aligned, NA_real_)),
  cl_closed_small = sum_na_safe(fifelse(!(CERT %in% large_cert), dep_lag1_aligned, NA_real_)),
  cl_closed_app   = sum_na_safe(fifelse(has_app == 1L & !(CERT %in% top4_cert), dep_lag1_aligned, NA_real_)),
  cl_closed_noapp = sum_na_safe(fifelse(has_app == 0L, dep_lag1_aligned, NA_real_))
), by = .(county, YEAR)]

county_closure_shares <- merge(county_totals, closed_by_app, by = c("county","YEAR"), all.x = TRUE)
county_closure_shares[is.na(cl_closed_top4),  cl_closed_top4  := 0]
county_closure_shares[is.na(cl_closed_large_but_not_top4), cl_closed_large_but_not_top4 := 0]
county_closure_shares[is.na(cl_closed_small), cl_closed_small := 0]
county_closure_shares[is.na(cl_closed_app),   cl_closed_app   := 0]
county_closure_shares[is.na(cl_closed_noapp), cl_closed_noapp := 0]

county_closure_shares[, share_deps_closed_top4 :=
                        fifelse(total_deps_county_lag1 > 0, cl_closed_top4 / total_deps_county_lag1, 0)
]
county_closure_shares[, share_deps_closed_large_but_not_top4 :=
                        fifelse(total_deps_county_lag1 > 0, cl_closed_large_but_not_top4 / total_deps_county_lag1, 0)
]
county_closure_shares[, share_deps_closed_small :=
                        fifelse(total_deps_county_lag1 > 0, cl_closed_small / total_deps_county_lag1, 0)
]
county_closure_shares[, share_deps_closed := share_deps_closed_top4 + share_deps_closed_large_but_not_top4 + share_deps_closed_small]

county_closure_shares[, share_deps_closed_app :=
                        fifelse(total_deps_county_lag1 > 0, cl_closed_app / total_deps_county_lag1, 0)
]
county_closure_shares[, share_deps_closed_noapp :=
                        fifelse(total_deps_county_lag1 > 0, cl_closed_noapp / total_deps_county_lag1, 0)
]
county_closure_shares[, share_deps_closed_nontop4 := share_deps_closed_large_but_not_top4 + share_deps_closed_small]
```


```{r}
#-----------------------------
# 4) County-year total deposits at t-1 and t+1
#-----------------------------

# Get county totals at each year (for all branches, including those that will close)
county_deps_all_years <- closure_app[, .(
  total_county_deps = sum_na_safe(DEPSUMBR)
), by = .(county, YEAR)]

# For market share calculation, we need:
# - Total at t-1 (includes all branches)
# - Total at t+1 (includes only survivors - branches that exist at t+1)

# Create helper: mark branches that exist at each time point
closure_app[, exists_t1 := !is.na(dep_lag1_aligned) & dep_lag1_aligned > 0]
closure_app[, exists_lead1 := !is.na(dep_lead1_aligned) & dep_lead1_aligned > 0]

# County totals at t-1 (all branches that existed then)
county_deps_t1 <- closure_app[exists_t1 == TRUE, .(
  total_county_deps_t1 = sum_na_safe(dep_lag1_aligned)
), by = .(county, YEAR)]

# County totals at t+1 (only survivors)
county_deps_lead1 <- closure_app[exists_lead1 == TRUE, .(
  total_county_deps_lead1 = sum_na_safe(dep_lead1_aligned)
), by = .(county, YEAR)]
```


```{r}
#-----------------------------
# 5) Minimal county controls
#-----------------------------

# 5a) Build bank-county-year totals (to define "incumbent")
bank_cty_yr <- closure_app[, .(
  deps_curr = sum_na_safe(DEPSUMBR),
  deps_lag1 = sum_na_safe(dep_lag1_aligned),
  n_close   = sum(closed == 1L, na.rm = TRUE)
), by = .(RSSDID, county, YEAR)]

bank_cty_yr[, bank_type := fifelse(n_close > 0L, "CLOSER", "INCUMBENT")]

# 5b) County-year counts of banks (lagged)
county_bankcounts <- bank_cty_yr[, .(
  banks_county_curr = .N
), by = .(county, YEAR)]
setorder(county_bankcounts, county, YEAR)
county_bankcounts[, banks_county_lag1 := shift(banks_county_curr, 1L, type = "lag"), by = county]

# 5c) County deposit totals from FDIC SoD
fdic_all <- readRDS(fdic_path); setDT(fdic_all)
fdic_all[, county := str_pad(STCNTYBR, 5, "left", "0")]
fdic_all[, YEAR := as.integer(YEAR)]

market_totals <- fdic_all[, .(total_deps = sum(DEPSUMBR, na.rm = TRUE)), by = .(county, YEAR)]
complete_grid <- CJ(county = unique(market_totals$county),
                    YEAR   = min(market_totals$YEAR):max(market_totals$YEAR))
market_bal <- merge(complete_grid, market_totals, by = c("county","YEAR"), all.x = TRUE)
market_bal[is.na(total_deps), total_deps := 0]
setorder(market_bal, county, YEAR)

market_bal[, deps_lag1 := shift(total_deps, 1L, type = "lag"), by = county]
market_bal[, deps_lag4 := shift(total_deps, 4L, type = "lag"), by = county]
market_bal[, county_dep_growth_t4_t1 := fifelse(deps_lag4 > 0,
                                                (deps_lag1 - deps_lag4) / deps_lag4,
                                                NA_real_)]

# 5d) Combine controls into one county-year table
controls_cy <- merge(county_bankcounts[, .(county, YEAR, banks_county_lag1)],
                     market_bal[, .(county, YEAR, deps_lag1, county_dep_growth_t4_t1)],
                     by = c("county","YEAR"), all.x = TRUE)

controls_cy <- merge(controls_cy, county_totals[, .(county, YEAR, total_deps_county_lag1)],
                     by = c("county","YEAR"), all.x = TRUE)
```


```{r}
#-----------------------------
# 6) Build regression branch panel
#-----------------------------
branch_panel <- closure_app[!is.na(gr_branch)]
branch_panel[, gr_branch := Winsorize(gr_branch, val = quantile(gr_branch, probs = c(0.025, 0.975), na.rm = FALSE))]
branch_panel[, state_yr := paste0(substr(county, 1, 2), YEAR)]
branch_panel[, bank_yr := paste0(RSSDID, YEAR)]

branch_panel <- merge(branch_panel,
                      county_closure_shares[, .(county, YEAR, share_deps_closed, 
                                                share_deps_closed_top4, share_deps_closed_large_but_not_top4, share_deps_closed_small,
                                                share_deps_closed_nontop4, share_deps_closed_app, share_deps_closed_noapp,
                                                cl_closed_top4, cl_closed_app, cl_closed_noapp)],
                      by = c("county","YEAR"),
                      all.x = TRUE)

branch_panel <- merge(branch_panel,
                      controls_cy[, .(county, YEAR, banks_county_lag1, county_dep_growth_t4_t1,
                                      deps_lag1)],
                      by = c("county","YEAR"),
                      all.x = TRUE)

# Merge county totals at t-1 and t+1
branch_panel <- merge(branch_panel,
                      county_deps_t1[, .(county, YEAR, total_county_deps_t1)],
                      by = c("county","YEAR"),
                      all.x = TRUE)

branch_panel <- merge(branch_panel,
                      county_deps_lead1[, .(county, YEAR, total_county_deps_lead1)],
                      by = c("county","YEAR"),
                      all.x = TRUE)

# Incumbent indicator at bank-county-year level
branch_panel <- merge(branch_panel,
                      bank_cty_yr[, .(RSSDID, county, YEAR, bank_type)],
                      by = c("RSSDID","county","YEAR"),
                      all.x = TRUE)
branch_panel[, incumbent_bank := fifelse(bank_type == "INCUMBENT", 1L, 0L)]

# Bank type dummies (top4_cert, large_cert defined in section 3)
branch_panel[, top4_bank := fifelse(CERT %in% top4_cert, 1L, 0L)]
branch_panel[, large_but_not_top4_bank := fifelse(!(CERT %in% top4_cert) & CERT %in% large_cert, 1L, 0L)]
branch_panel[, small_bank := fifelse(!(CERT %in% top4_cert) & !(CERT %in% large_cert), 1L, 0L)]
```


```{r}
#-----------------------------
# 7) NEW: Calculate Market Share Changes
#-----------------------------

# Only keep branches that existed at BOTH t-1 and t+1 (survivors)
branch_panel <- branch_panel[
  !is.na(dep_lag1_aligned) & dep_lag1_aligned > 0 &
    !is.na(dep_lead1_aligned) & dep_lead1_aligned > 0
]

# Market share at t-1 (among all branches that existed at t-1)
branch_panel[, mkt_share_t1 := fifelse(total_county_deps_t1 > 0,
                                       dep_lag1_aligned / total_county_deps_t1,
                                       NA_real_)]

# Market share at t+1 (among only survivors)
branch_panel[, mkt_share_lead1 := fifelse(total_county_deps_lead1 > 0,
                                          dep_lead1_aligned / total_county_deps_lead1,
                                          NA_real_)]

# Change in market share (percentage points)
branch_panel[, delta_mkt_share := mkt_share_lead1 - mkt_share_t1]


# Winsorize
branch_panel[, delta_mkt_share_win := Winsorize(delta_mkt_share, 
                                                val = quantile(delta_mkt_share, 
                                                               probs = c(0.01, 0.99), 
                                                               na.rm = TRUE))]
```


```{r}
#-----------------------------
# 7b) Drop in visits (2019 vs 2021) – bank-level aggregate, then merge by CERT
#-----------------------------
library(lubridate)
data_dir_visits <- "C:/OneDrive/data/nrs_branch_closure"
branch_visits <- readRDS(file.path(data_dir_visits, "bank_branch_visits_count_2019_2022.rds"))
setDT(branch_visits)
branch_visits[, yr := year(DATE_RANGE_START)]
branch_visits <- branch_visits[yr %in% c(2019, 2021)]
branch_bank <- closure_app[order(UNINUMBR, -YEAR)][, .SD[1], by = UNINUMBR][, .(UNINUMBR, CERT)]
branch_visits <- merge(branch_visits, branch_bank, by = "UNINUMBR", all.x = TRUE)
bank_change <- branch_visits[, .(total_visits = sum(RAW_VISIT_COUNTS, na.rm = TRUE)), by = .(CERT, yr)]
bank_change <- dcast(bank_change, CERT ~ yr, value.var = "total_visits")
bank_change[, drop_in_visits := (`2019` - `2021`) / `2019`]
bank_change[, drop_in_visits := Winsorize(drop_in_visits, quantile(drop_in_visits, probs = c(0.01, 0.99), na.rm = TRUE))]
bank_change[, high_drop_visits := as.integer(drop_in_visits > median(drop_in_visits, na.rm = TRUE))]
branch_panel <- merge(branch_panel, bank_change[, .(CERT, drop_in_visits, high_drop_visits)], by = "CERT", all.x = TRUE)
cat("Bank-level drop_in_visits / high_drop_visits merged into branch_panel by CERT.\n")
```

```{r}
#-----------------------------
# 7c) App quality vs other banks in county: best in county, above median in county
#-----------------------------
bank_cy_rating <- unique(closure_app[, .(CERT, county, YEAR, rating = own_bank_app_rating)])
cy_stats <- bank_cy_rating[, .(max_rating = max(rating, na.rm = TRUE), med_rating = median(rating, na.rm = TRUE)), by = .(county, YEAR)]
bank_cy_rating <- merge(bank_cy_rating, cy_stats, by = c("county", "YEAR"))
bank_cy_rating[, best_app_in_county := as.integer(rating >= max_rating)]
bank_cy_rating[, above_median_app_in_county := as.integer(rating > med_rating)]
app_quality_cy <- bank_cy_rating[, .(CERT, county, YEAR, best_app_in_county, above_median_app_in_county)]
branch_panel <- merge(branch_panel, app_quality_cy, by = c("CERT", "county", "YEAR"), all.x = TRUE)
cat("best_app_in_county and above_median_app_in_county merged into branch_panel.\n")
```


```{r}
#-----------------------------
# 8) Final regression sample
#-----------------------------
branch_panel[, closer_remaining_branch := 1L - incumbent_bank]

# Merge county-year controls panel (from create_county_controls_panel.R; county_code = county, year = YEAR)
data_dir_nrs <- "C:/OneDrive/data/nrs_branch_closure"

county_controls_panel <- readRDS(file.path(data_dir_nrs, "county_controls_panel.rds"))
setDT(county_controls_panel)
branch_panel <- merge(branch_panel, county_controls_panel,
                      by.x = c("county", "YEAR"), by.y = c("county_code", "year"), all.x = TRUE)

reg_dt <- branch_panel[
  YEAR >= start_year & YEAR <= end_year &
    banks_county_lag1 >= 3
]

# Bank type factor: other = omitted reference, then top4, large_but_not_top4
reg_dt[, bank_type_fct := factor(
  fcase(top4_bank == 1L, "top4",
        large_but_not_top4_bank == 1L, "large_but_not_top4",
        default = "other"),
  levels = c("other", "top4", "large_but_not_top4")
)]

reg_dt[,county_yr:=paste0(county,YEAR)]


```

```{r}
#| warning: false
#| messages: false

# Mean of share_deps_closed variables by year (among county-years with share_deps_closed > 0)
share_means <- reg_dt[share_deps_closed > 0, .(
  share_deps_closed      = mean(share_deps_closed, na.rm = TRUE),
  share_deps_closed_top4 = mean(share_deps_closed_top4, na.rm = TRUE),
  share_deps_closed_large_but_not_top4 = mean(share_deps_closed_large_but_not_top4, na.rm = TRUE),
  share_deps_closed_small = mean(share_deps_closed_small, na.rm = TRUE),
  share_deps_closed_app  = mean(share_deps_closed_app, na.rm = TRUE),
  share_deps_closed_noapp = mean(share_deps_closed_noapp, na.rm = TRUE)
), by = YEAR]

share_means_long <- melt(share_means, id.vars = "YEAR", 
                         variable.name = "variable", value.name = "mean_share")

ggplot(share_means_long, aes(x = YEAR, y = mean_share, color = variable)) +
  geom_line(linewidth = 1) +
  geom_point(size = 2) +
  labs(title = "Mean Closure Shares by Year (County-Years with share_deps_closed > 0)",
       x = "Year", y = "Mean Share", color = "Variable") +
  theme_minimal() +
  scale_color_manual(values = c("share_deps_closed" = "black",
                                "share_deps_closed_top4" = "red",
                                "share_deps_closed_large_but_not_top4" = "orange",
                                "share_deps_closed_small" = "purple",
                                "share_deps_closed_app" = "blue",
                                "share_deps_closed_noapp" = "darkgreen"))
```

```{r}
#-----------------------------
# 10) Regressions
#-----------------------------

setFixest_fml(
  ..fixef_branch = ~ UNINUMBR+ state_yr + bank_yr ,
  ..fixef_sy_by = ~ state_yr + bank_yr ,
  ..controls = ~ log1p(banks_county_lag1) + county_dep_growth_t4_t1 + log1p(dep_lag1_aligned) +
    log_population_density + lag_county_deposit_hhi + lag_establishment_gr + lag_payroll_gr +
    lag_hmda_mtg_amt_gr + lag_cra_loan_amount_amt_lt_1m_gr +  lmi
)

setFixest_etable(
  signif.code = c("***" = 0.01, "**" = 0.05, "*" = 0.1),
  se.below = T
)

```


```{r}
r_original <- list()
r_original[[1]] <- feols(gr_branch ~ share_deps_closed + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_original[[2]] <- feols(gr_branch ~ share_deps_closed + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_original[[3]] <- feols(gr_branch ~ share_deps_closed + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)
r_original[[4]] <- feols(gr_branch ~ share_deps_closed + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)

etable(r_original, headers = list("2012-2019" = 2, "2020-2024" = 2))
```



```{r}
r_byapp <- list()
r_byapp[[1]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_byapp[[2]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_byapp[[3]] <- feols(gr_branch ~ share_deps_closed_small + share_deps_closed_large_but_not_top4 + share_deps_closed_top4 + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)
r_byapp[[4]] <- feols(gr_branch ~ share_deps_closed_small + share_deps_closed_large_but_not_top4 + share_deps_closed_top4 + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)

etable(r_byapp, headers = list("2020-2024 (best app)" = 2, "2020-2024 (above med)" = 2), order = c("share_deps_closed_app","share_deps_closed_noapp","share_deps_closed_top4",
                                                                           "share_deps_closed_large_but_not_top4","share_deps_closed_small","best_app_in_county"))
```


```{r}
# Create constraint matrix: [1, -1, 0, ...] to test β_app - β_noapp = 0
library(car)  # for linearHypothesis

linearHypothesis(r_byapp[[1]], 
                 "share_deps_closed_app = share_deps_closed_noapp",
                 vcov = vcov(r_byapp[[2]]))

linearHypothesis(r_byapp[[2]], 
                 "share_deps_closed_app = share_deps_closed_noapp",
                 vcov = vcov(r_byapp[[2]]))
```


```{r}
r_byapp <- list()
r_byapp[[1]] <- feols(gr_branch ~ share_deps_closed_small*best_app_in_county + share_deps_closed_large_but_not_top4*best_app_in_county + share_deps_closed_top4*best_app_in_county + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 ], vcov = ~UNINUMBR)
r_byapp[[2]] <- feols(gr_branch ~ share_deps_closed_small*best_app_in_county + share_deps_closed_large_but_not_top4*best_app_in_county + share_deps_closed_top4*best_app_in_county + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 ], vcov = ~UNINUMBR)
r_byapp[[3]] <- feols(gr_branch ~ share_deps_closed_small*above_median_app_in_county + share_deps_closed_large_but_not_top4*above_median_app_in_county + share_deps_closed_top4*above_median_app_in_county + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 ], vcov = ~UNINUMBR)
r_byapp[[4]] <- feols(gr_branch ~ share_deps_closed_small*above_median_app_in_county + share_deps_closed_large_but_not_top4*above_median_app_in_county + share_deps_closed_top4*above_median_app_in_county + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 ], vcov = ~UNINUMBR)


etable(r_byapp, headers = list("2020-2024 (best app)" = 2, "2020-2024 (above med)" = 2), order = c("share_deps_closed_app","share_deps_closed_noapp","share_deps_closed_top4",
                                                                           "share_deps_closed_large_but_not_top4","share_deps_closed_small","best_app_in_county"))

```

```{r}
r_byapp <- list()
r_byapp[[1]] <- feols(gr_branch ~ share_deps_closed*drop_in_visits + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 ], vcov = ~UNINUMBR)
r_byapp[[2]] <- feols(gr_branch ~ share_deps_closed*drop_in_visits + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 ], vcov = ~UNINUMBR)
r_byapp[[3]] <- feols(gr_branch ~ share_deps_closed*high_drop_visits + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 ], vcov = ~UNINUMBR)
r_byapp[[4]] <- feols(gr_branch ~ share_deps_closed*high_drop_visits + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 ], vcov = ~UNINUMBR)

etable(r_byapp, headers = list("2020-2024 (drop)" = 2, "2020-2024 (high drop)" = 2), order = c("share_deps_closed_app","share_deps_closed_noapp","share_deps_closed_top4",
                                                                           "share_deps_closed_large_but_not_top4","share_deps_closed_small","best_app_in_county"))
```


```{r}
r_original <- list()
r_original[[1]] <- feols(gr_branch ~ share_deps_closed*top4_bank + share_deps_closed*large_but_not_top4_bank + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_original[[2]] <- feols(gr_branch ~ share_deps_closed*top4_bank + share_deps_closed*large_but_not_top4_bank + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_original[[3]] <- feols(gr_branch ~ share_deps_closed*top4_bank + share_deps_closed*large_but_not_top4_bank + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)
r_original[[4]] <- feols(gr_branch ~ share_deps_closed*top4_bank + share_deps_closed*large_but_not_top4_bank + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)

etable(r_original, headers = list("2012-2019" = 2, "2020-2024" = 2), order=c("share_deps_closed"))
```




```{r}
r_byapp <- list()
r_byapp[[1]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_byapp[[2]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_byapp[[3]] <- feols(gr_branch ~ share_deps_closed_small + share_deps_closed_large_but_not_top4 + share_deps_closed_top4 + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)
r_byapp[[4]] <- feols(gr_branch ~ share_deps_closed_small + share_deps_closed_large_but_not_top4 + share_deps_closed_top4 + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)
r_byapp[[5]] <- feols(gr_branch ~ share_deps_closed_small*own_bank_app_rating + share_deps_closed_large_but_not_top4*own_bank_app_rating + share_deps_closed_top4*own_bank_app_rating + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 & own_bank_app_rating>1], vcov = ~UNINUMBR)
r_byapp[[6]] <- feols(gr_branch ~ share_deps_closed_small*own_bank_app_rating + share_deps_closed_large_but_not_top4*own_bank_app_rating + share_deps_closed_top4*own_bank_app_rating + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020 & own_bank_app_rating>1], vcov = ~UNINUMBR)

etable(r_byapp, headers = list("2012-2019" = 2, "2020-2025" = 2, "2020-2025 (rating)" = 2), order = c("share_deps_closed_app","share_deps_closed_noapp","share_deps_closed_top4",
                                                                           "share_deps_closed_large_but_not_top4","share_deps_closed_small"))
```

```{r}
r_original <- list()
r_original[[1]] <- feols(gr_branch ~ share_deps_closed*closer_remaining_branch + ..controls | ..fixef_branch,
                         data = reg_dt[YEAR<=2019], vcov = ~UNINUMBR)
r_original[[2]] <- feols(gr_branch ~ share_deps_closed*closer_remaining_branch + ..controls | ..fixef_sy_by,
                         data = reg_dt[YEAR<=2019], vcov = ~UNINUMBR)
r_original[[3]] <- feols(gr_branch ~ share_deps_closed*closer_remaining_branch + ..controls | ..fixef_branch,
                         data = reg_dt[YEAR>=2020], vcov = ~UNINUMBR)
r_original[[4]] <- feols(gr_branch ~ share_deps_closed*closer_remaining_branch + ..controls | ..fixef_sy_by,
                         data = reg_dt[YEAR>=2020], vcov = ~UNINUMBR)

etable(r_original, headers = list("2012-2019" = 2, "2020-2025" = 2))
```


```{r}
r_byapp <- list()
r_byapp[[1]] <- feols(gr_branch ~ share_deps_closed_app*bank_type_fct + share_deps_closed_noapp*bank_type_fct + share_deps_closed_top4*bank_type_fct + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_byapp[[2]] <- feols(gr_branch ~ share_deps_closed_app*bank_type_fct + share_deps_closed_noapp*bank_type_fct + share_deps_closed_top4*bank_type_fct + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR<=2019], vcov = ~UNINUMBR)
r_byapp[[3]] <- feols(gr_branch ~ share_deps_closed_small*bank_type_fct + share_deps_closed_large_but_not_top4*bank_type_fct + share_deps_closed_top4*bank_type_fct + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)
r_byapp[[4]] <- feols(gr_branch ~ share_deps_closed_small*bank_type_fct + share_deps_closed_large_but_not_top4*bank_type_fct + share_deps_closed_top4*bank_type_fct + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR>=2020], vcov = ~UNINUMBR)

etable(r_byapp, headers = list("2012-2019" = 2, "2020-2025" = 2), order = c("share_deps_closed_app","share_deps_closed_noapp","share_deps_closed_top4",
                                                                           "share_deps_closed_large_but_not_top4","share_deps_closed_small"))
```

```{r}
r_byapp <- list()
r_byapp[[1]] <- feols(gr_branch ~ share_deps_closed_app*closer_remaining_branch + share_deps_closed_noapp*closer_remaining_branch + share_deps_closed_top4*closer_remaining_branch + ..controls | ..fixef_branch,
                         data = reg_dt[YEAR<=2019], vcov = ~UNINUMBR)
r_byapp[[2]] <- feols(gr_branch ~ share_deps_closed_app*closer_remaining_branch + share_deps_closed_noapp*closer_remaining_branch + share_deps_closed_top4*closer_remaining_branch + ..controls | ..fixef_sy_by,
                         data = reg_dt[YEAR<=2019], vcov = ~UNINUMBR)
r_byapp[[3]] <- feols(gr_branch ~ share_deps_closed_small*closer_remaining_branch + share_deps_closed_large_but_not_top4*closer_remaining_branch + share_deps_closed_top4*closer_remaining_branch + ..controls | ..fixef_branch,
                         data = reg_dt[YEAR>=2020], vcov = ~UNINUMBR)
r_byapp[[4]] <- feols(gr_branch ~ share_deps_closed_small*closer_remaining_branch + share_deps_closed_large_but_not_top4*closer_remaining_branch + share_deps_closed_top4*closer_remaining_branch + ..controls | ..fixef_sy_by,
                         data = reg_dt[YEAR>=2020], vcov = ~UNINUMBR)

etable(r_byapp, headers = list("2012-2019" = 2, "2020-2025" = 2), order = c("share_deps_closed_app","share_deps_closed_noapp","share_deps_closed_top4",
                                                                           "share_deps_closed_large_but_not_top4","share_deps_closed_small"))
```


```{r}

cat("\n\n=== ORIGINAL REGRESSIONS (Growth Rate) ===\n\n")

r_original <- list()
r_original[[1]] <- feols(gr_branch ~ share_deps_closed + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)
r_original[[2]] <- feols(gr_branch ~ share_deps_closed + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)

r_original[[3]] <- feols(gr_branch ~ share_deps_closed * own_bank_has_app + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)
r_original[[4]] <- feols(gr_branch ~ share_deps_closed * own_bank_has_app + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)

r_original[[5]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)
r_original[[6]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)

r_original[[7]] <- feols(gr_branch ~ share_deps_closed_app * own_bank_has_app +
                           share_deps_closed_noapp * own_bank_has_app + 
                           share_deps_closed_top4 * own_bank_has_app + ..controls |
                           ..fixef_branch,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)
r_original[[8]] <- feols(gr_branch ~ share_deps_closed_app * own_bank_has_app +
                           share_deps_closed_noapp * own_bank_has_app + 
                           share_deps_closed_top4 * own_bank_has_app + ..controls |
                           ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)

r_original[[9]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 & YEAR < 2016], vcov = ~UNINUMBR)
r_original[[10]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 & YEAR < 2016], vcov = ~UNINUMBR)

r_original[[11]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1 &  YEAR >= 2016], vcov = ~UNINUMBR)
r_original[[12]] <- feols(gr_branch ~ share_deps_closed_app + share_deps_closed_noapp + share_deps_closed_top4 + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1 &  YEAR >= 2016], vcov = ~UNINUMBR)

r_original[[13]] <- feols(gr_branch ~ share_deps_closed * best_app_in_county + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)
r_original[[14]] <- feols(gr_branch ~ share_deps_closed * best_app_in_county + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)
r_original[[15]] <- feols(gr_branch ~ share_deps_closed * above_median_app_in_county + ..controls | ..fixef_branch,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)
r_original[[16]] <- feols(gr_branch ~ share_deps_closed * above_median_app_in_county + ..controls | ..fixef_sy_by,
                         data = reg_dt[incumbent_bank==1], vcov = ~UNINUMBR)

# r_original[[5]] <- feols(gr_branch ~ share_deps_closed_app * top4_bank +
#                            share_deps_closed_noapp * top4_bank + ..controls |
#                            ..fixef_branch,
#                          data = reg_dt, vcov = ~UNINUMBR)

etable(r_original, headers = list("Total" = 2, "+ Own App" = 2, "CB App/NoApp" = 2, "+ Own App" = 2, "< 2016" = 2, ">=2016" = 2, "Best in county" = 2, "Above med in county" = 2))

```


```{r}
r_original2 <- list()
r_original2[[1]] <- feols(gr_branch ~ share_deps_closed*closer_remaining_branch + ..controls | ..fixef_branch,
                         data = reg_dt, vcov = ~UNINUMBR)
r_original2[[2]] <- feols(gr_branch ~ share_deps_closed*closer_remaining_branch + ..controls | ..fixef_sy_by,
                         data = reg_dt, vcov = ~UNINUMBR)

r_original2[[3]] <- feols(gr_branch ~ share_deps_closed_app*closer_remaining_branch + share_deps_closed_noapp*closer_remaining_branch + share_deps_closed_top4*closer_remaining_branch+ ..controls | ..fixef_branch,
                         data = reg_dt, vcov = ~UNINUMBR)
r_original2[[4]] <- feols(gr_branch ~ share_deps_closed_app*closer_remaining_branch + share_deps_closed_noapp*closer_remaining_branch + share_deps_closed_top4*closer_remaining_branch+ ..controls | ..fixef_sy_by,
                         data = reg_dt, vcov = ~UNINUMBR)

# r_original[[5]] <- feols(gr_branch ~ share_deps_closed_app * top4_bank +
#                            share_deps_closed_noapp * top4_bank + ..controls |
#                            ..fixef_branch,
#                          data = reg_dt, vcov = ~UNINUMBR)

etable(r_original2, headers = list("Total" = 2, "CB App/NoApp" = 2))
```






















